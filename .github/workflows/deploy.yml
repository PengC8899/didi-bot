name: Deploy to VPS

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, master ]  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      deployment_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'git'
        type: choice
        options:
        - git
        - docker
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

# ç¯å¢ƒå˜é‡
env:
  IMAGE_NAME: ddgl-orderbot
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Code formatting check
      run: |
        black --check orderbot/
        isort --check-only orderbot/

    - name: Lint with flake8
      run: |
        flake8 orderbot/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 orderbot/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  # Gitéƒ¨ç½²
  deploy-git:
    needs: quality-check
    runs-on: ubuntu-latest
    if: github.event.inputs.deployment_type == 'git' || github.event.inputs.deployment_type == ''
    
    steps:
    - name: Deploy via Git
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          set -e
          
          # é¡¹ç›®è·¯å¾„
          PROJECT_PATH="/home/${{ secrets.VPS_USER }}/DDGL_bot"
          
          echo "ğŸ”„ å¼€å§‹Gitéƒ¨ç½²..."
          
          # å…‹éš†æˆ–æ›´æ–°ä»£ç 
          if [ ! -d "$PROJECT_PATH" ]; then
            echo "ğŸ“¥ å…‹éš†ä»£ç ä»“åº“..."
            git clone ${{ secrets.REPO_URL }} "$PROJECT_PATH"
          else
            echo "ğŸ”„ æ›´æ–°ä»£ç ..."
            cd "$PROJECT_PATH"
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
          fi
          
          cd "$PROJECT_PATH"
          
          # æ£€æŸ¥.envæ–‡ä»¶
          if [ ! -f ".env" ]; then
            if [ -f ".env.example" ]; then
              cp .env.example .env
              echo "âš ï¸  å·²åˆ›å»º.envæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥é…ç½®ï¼"
            else
              echo "âŒ æœªæ‰¾åˆ°.envæ–‡ä»¶ï¼"
              exit 1
            fi
          fi
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
          docker-compose down || true
          
          # æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
          echo "ğŸ”¨ æ„å»ºå¹¶å¯åŠ¨æœåŠ¡..."
          docker-compose up -d --build
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 15
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          docker-compose ps
          
          # å¥åº·æ£€æŸ¥
          if docker-compose exec -T orderbot python -c "print('Bot is running')" 2>/dev/null; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼æœºå™¨äººæœåŠ¡æ­£å¸¸è¿è¡Œ"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼æœºå™¨äººæœåŠ¡å¼‚å¸¸"
            docker-compose logs --tail=20 orderbot
            exit 1
          fi

  # Dockeré•œåƒéƒ¨ç½²
  deploy-docker:
    needs: quality-check
    runs-on: ubuntu-latest
    if: github.event.inputs.deployment_type == 'docker'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
        docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ env.IMAGE_NAME }}:latest

    - name: Save Docker image
      run: |
        docker save -o ${{ env.IMAGE_NAME }}-${{ env.IMAGE_TAG }}.tar ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        gzip ${{ env.IMAGE_NAME }}-${{ env.IMAGE_TAG }}.tar

    - name: Upload image to VPS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        source: "${{ env.IMAGE_NAME }}-${{ env.IMAGE_TAG }}.tar.gz"
        target: "/home/${{ secrets.VPS_USER }}/"

    - name: Deploy Docker container
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          set -e
          
          PROJECT_PATH="/home/${{ secrets.VPS_USER }}/DDGL_bot"
          IMAGE_FILE="${{ env.IMAGE_NAME }}-${{ env.IMAGE_TAG }}.tar.gz"
          
          echo "ğŸ³ å¼€å§‹Dockeréƒ¨ç½²..."
          
          # åˆ›å»ºé¡¹ç›®ç›®å½•
          mkdir -p "$PROJECT_PATH"
          cd "$PROJECT_PATH"
          
          # è§£å‹å¹¶åŠ è½½é•œåƒ
          echo "ğŸ“¦ åŠ è½½Dockeré•œåƒ..."
          gunzip -f "/home/${{ secrets.VPS_USER }}/$IMAGE_FILE"
          docker load -i "/home/${{ secrets.VPS_USER }}/${{ env.IMAGE_NAME }}-${{ env.IMAGE_TAG }}.tar"
          
          # æ¸…ç†é•œåƒæ–‡ä»¶
          rm -f "/home/${{ secrets.VPS_USER }}/${{ env.IMAGE_NAME }}-${{ env.IMAGE_TAG }}.tar"
          
          # åœæ­¢ç°æœ‰å®¹å™¨
          echo "ğŸ›‘ åœæ­¢ç°æœ‰å®¹å™¨..."
          docker stop orderbot || true
          docker rm orderbot || true
          
          # æ£€æŸ¥.envæ–‡ä»¶
          if [ ! -f ".env" ]; then
            echo "âŒ æœªæ‰¾åˆ°.envæ–‡ä»¶ï¼è¯·å…ˆåˆ›å»ºé…ç½®æ–‡ä»¶"
            exit 1
          fi
          
          # å¯åŠ¨æ–°å®¹å™¨
          echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
          docker run -d \
            --name orderbot \
            --restart unless-stopped \
            --env-file .env \
            -v $(pwd)/data:/app/data \
            -v $(pwd)/logs:/app/logs \
            -v $(pwd)/images:/app/images \
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          
          # ç­‰å¾…å®¹å™¨å¯åŠ¨
          echo "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨..."
          sleep 15
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          echo "ğŸ” æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
          docker ps --filter name=orderbot
          
          # å¥åº·æ£€æŸ¥
          if docker exec orderbot python -c "print('Bot is running')" 2>/dev/null; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼æœºå™¨äººæœåŠ¡æ­£å¸¸è¿è¡Œ"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼æœºå™¨äººæœåŠ¡å¼‚å¸¸"
            docker logs --tail=20 orderbot
            exit 1
          fi

  # éƒ¨ç½²é€šçŸ¥
  notify:
    needs: [deploy-git, deploy-docker]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify deployment result
      uses: appleboy/telegram-action@master
      if: secrets.TELEGRAM_BOT_TOKEN && secrets.TELEGRAM_CHAT_ID
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ğŸš€ DDGL Bot éƒ¨ç½²ç»“æœ
          
          ğŸ“‹ è¯¦æƒ…ï¼š
          - ä»“åº“: ${{ github.repository }}
          - åˆ†æ”¯: ${{ github.ref_name }}
          - æäº¤: ${{ github.sha }}
          - éƒ¨ç½²ç±»å‹: ${{ github.event.inputs.deployment_type || 'git' }}
          - ç¯å¢ƒ: ${{ github.event.inputs.environment || 'production' }}
          - çŠ¶æ€: ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}
          
          ğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}